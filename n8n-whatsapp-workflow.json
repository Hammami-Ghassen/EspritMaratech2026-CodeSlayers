{
  "name": "ASTBA ‚Äì WhatsApp Automations v3",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "trainer-assigned",
        "responseMode": "onReceived",
        "responseData": "allEntries",
        "options": {}
      },
      "id": "wh-trainer",
      "name": "Webhook Trainer",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 400],
      "webhookId": "trainer-assigned"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "seance-reported",
        "responseMode": "onReceived",
        "responseData": "allEntries",
        "options": {}
      },
      "id": "wh-reported",
      "name": "Webhook Reported",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 740],
      "webhookId": "seance-reported"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "student-absent",
        "responseMode": "onReceived",
        "responseData": "allEntries",
        "options": {}
      },
      "id": "wh-absent",
      "name": "Webhook Absent",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 60],
      "webhookId": "student-absent"
    },
    {
      "parameters": {
        "jsCode": "// Grab the raw input and find the data no matter how n8n nests it\nconst raw = $input.first().json;\n\n// Debug: output what we actually received\nconst d = raw.body && typeof raw.body === 'object' && Object.keys(raw.body).length > 0\n  ? raw.body\n  : raw;\n\nconst phone = d.trainerPhone || '';\nconst name = d.trainerName || '';\nconst training = d.trainingTitle || '';\nconst seance = d.seanceTitle || '';\nconst group = d.groupName || '';\nconst date = d.date || '';\nconst start = d.startTime || '';\nconst end = d.endTime || '';\nconst level = d.levelNumber || '';\nconst session = d.sessionNumber || '';\n\nreturn [{\n  json: {\n    messaging_product: 'whatsapp',\n    to: phone,\n    type: 'text',\n    text: {\n      preview_url: false,\n      body: 'üìã *ASTBA ‚Äì Nouvelle S√©ance Assign√©e*\\n\\nBonjour ' + name + ',\\n\\nUne nouvelle s√©ance vous a √©t√© assign√©e :\\n\\nüìö *Formation :* ' + training + '\\nüìñ *S√©ance :* ' + seance + '\\nüë• *Groupe :* ' + group + '\\nüìÖ *Date :* ' + date + '\\n‚è∞ *Horaire :* ' + start + ' ‚Äì ' + end + '\\nüî¢ *Niveau :* ' + level + ' | *Session :* ' + session + '\\n\\nMerci de confirmer votre disponibilit√©.\\n\\nCordialement,\\nL\\'√©quipe ASTBA'\n    },\n    _debug: { rawKeys: Object.keys(raw), bodyKeys: raw.body ? Object.keys(raw.body) : 'no body', phone: phone }\n  }\n}];"
      },
      "id": "code-trainer",
      "name": "Build Trainer Msg",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [480, 400]
    },
    {
      "parameters": {
        "jsCode": "const raw = $input.first().json;\nconst d = raw.body && typeof raw.body === 'object' && Object.keys(raw.body).length > 0\n  ? raw.body\n  : raw;\n\nconst phone = d.managerPhone || '';\nconst trainerName = d.trainerName || '';\nconst seance = d.seanceTitle || '';\nconst training = d.trainingTitle || '';\nconst date = d.date || '';\nconst reason = d.reason || '';\nconst suggested = d.suggestedDate || 'Non sp√©cifi√©e';\n\nreturn [{\n  json: {\n    messaging_product: 'whatsapp',\n    to: phone,\n    type: 'text',\n    text: {\n      preview_url: false,\n      body: '‚ö†Ô∏è *ASTBA ‚Äì S√©ance Report√©e*\\n\\nLe formateur *' + trainerName + '* a report√© une s√©ance :\\n\\nüìñ *S√©ance :* ' + seance + '\\nüìö *Formation :* ' + training + '\\nüìÖ *Date initiale :* ' + date + '\\n\\nüìù *Raison :* ' + reason + '\\nüìÖ *Date sugg√©r√©e :* ' + suggested + '\\n\\nVeuillez prendre les mesures n√©cessaires.\\n\\nCordialement,\\nL\\'√©quipe ASTBA'\n    },\n    _debug: { rawKeys: Object.keys(raw), bodyKeys: raw.body ? Object.keys(raw.body) : 'no body', phone: phone }\n  }\n}];"
      },
      "id": "code-reported",
      "name": "Build Reported Msg",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [480, 740]
    },
    {
      "parameters": {
        "jsCode": "const raw = $input.first().json;\nconst d = raw.body && typeof raw.body === 'object' && Object.keys(raw.body).length > 0\n  ? raw.body\n  : raw;\n\nconst phone = d.studentPhone || '';\nconst name = d.studentName || '';\nconst training = d.trainingTitle || '';\nconst seance = d.seanceTitle || '';\nconst date = d.date || '';\nconst start = d.startTime || '';\nconst end = d.endTime || '';\n\nreturn [{\n  json: {\n    messaging_product: 'whatsapp',\n    to: phone,\n    type: 'text',\n    text: {\n      preview_url: false,\n      body: 'üéì *ASTBA ‚Äì Plan de rattrapage*\\n\\nBonjour ' + name + ',\\n\\nVous avez √©t√© marqu√©(e) absent(e) √† la s√©ance suivante :\\n\\nüìö *Formation :* ' + training + '\\nüìñ *S√©ance :* ' + seance + '\\nüìÖ *Date :* ' + date + '\\n‚è∞ *Horaire :* ' + start + ' ‚Äì ' + end + '\\n\\nüìã *Plan de rattrapage :*\\nVeuillez contacter votre formateur pour planifier une s√©ance de rattrapage.\\n\\nüìû Contact ASTBA : +216 29 040 316\\n\\nCordialement,\\nL\\'√©quipe ASTBA'\n    },\n    _debug: { rawKeys: Object.keys(raw), bodyKeys: raw.body ? Object.keys(raw.body) : 'no body', phone: phone }\n  }\n}];"
      },
      "id": "code-absent",
      "name": "Build Absent Msg",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [480, 60]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v22.0/986079917926325/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ messaging_product: $json.messaging_product, to: $json.to, type: $json.type, text: $json.text }) }}",
        "options": {}
      },
      "id": "http-trainer",
      "name": "Send WhatsApp Trainer",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [720, 400],
      "credentials": {
        "httpHeaderAuth": {
          "id": "whatsapp-auth",
          "name": "WhatsApp Business API"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v22.0/986079917926325/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ messaging_product: $json.messaging_product, to: $json.to, type: $json.type, text: $json.text }) }}",
        "options": {}
      },
      "id": "http-reported",
      "name": "Send WhatsApp Reported",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [720, 740],
      "credentials": {
        "httpHeaderAuth": {
          "id": "whatsapp-auth",
          "name": "WhatsApp Business API"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v22.0/986079917926325/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ messaging_product: $json.messaging_product, to: $json.to, type: $json.type, text: $json.text }) }}",
        "options": {}
      },
      "id": "http-absent",
      "name": "Send WhatsApp Absent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [720, 60],
      "credentials": {
        "httpHeaderAuth": {
          "id": "whatsapp-auth",
          "name": "WhatsApp Business API"
        }
      }
    }
  ],
  "connections": {
    "Webhook Trainer": {
      "main": [[{ "node": "Build Trainer Msg", "type": "main", "index": 0 }]]
    },
    "Build Trainer Msg": {
      "main": [
        [{ "node": "Send WhatsApp Trainer", "type": "main", "index": 0 }]
      ]
    },
    "Webhook Reported": {
      "main": [[{ "node": "Build Reported Msg", "type": "main", "index": 0 }]]
    },
    "Build Reported Msg": {
      "main": [
        [{ "node": "Send WhatsApp Reported", "type": "main", "index": 0 }]
      ]
    },
    "Webhook Absent": {
      "main": [[{ "node": "Build Absent Msg", "type": "main", "index": 0 }]]
    },
    "Build Absent Msg": {
      "main": [[{ "node": "Send WhatsApp Absent", "type": "main", "index": 0 }]]
    }
  },
  "pinData": {},
  "settings": { "executionOrder": "v1" },
  "staticData": null,
  "tags": [],
  "triggerCount": 3
}
